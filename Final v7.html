<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tip Pooler — Dagennaro Restaurant</title>
<style>
  :root{
    --bg:#111; --card:#1b1b1b; --ink:#f5f5f5; --muted:#b7b7b7;
    --accent:#ffd54f; --danger:#ff6b6b; --border:#2b2b2b;
  }
  /* THEME VARIANTS */
  body.theme-dark { --bg:#111; --card:#1b1b1b; --ink:#f5f5f5; --muted:#b7b7b7; --accent:#ffd54f; --danger:#ff6b6b; --border:#2b2b2b; }
  body.theme-light{ --bg:#fafafa; --card:#ffffff; --ink:#111111; --muted:#555555; --accent:#1976d2; --danger:#b00020; --border:#e2e2e2; }
  body.theme-blue { --bg:#0d1b2a; --card:#1b263b; --ink:#e0e1dd; --muted:#778da9; --accent:#00b4d8; --danger:#ff6b6b; --border:#24324a; }
  body.theme-green{ --bg:#0f2f1c; --card:#1a3a26; --ink:#e8f5e9; --muted:#a5d6a7; --accent:#66bb6a; --danger:#ef5350; --border:#2e7d32; }
  body.theme-red  { --bg:#2a0f0f; --card:#3a1a1a; --ink:#fdecea; --muted:#ef9a9a; --accent:#e53935; --danger:#ff5252; --border:#8e2424; }
  body.theme-purple{--bg:#1e1030; --card:#2a1a40; --ink:#f3e5f5; --muted:#ce93d8; --accent:#ab47bc; --danger:#ef5350; --border:#6a1b9a; }

  html,body{background:var(--bg);color:var(--ink);margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;background:linear-gradient(180deg,#141414,#111);border-bottom:1px solid var(--border);padding:14px 12px;display:flex;align-items:center;gap:10px;z-index:9}
  header h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
  header small{color:var(--muted);font-weight:500}
  nav{display:flex;gap:6px;margin-left:auto}
  nav button{background:var(--card);color:var(--ink);border:1px solid var(--border);padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer}
  nav button.active{outline:2px solid var(--accent)}
  .theme-wrap{display:flex;align-items:center;gap:8px;margin-left:8px}
  .theme-wrap label{font-size:12px;color:var(--muted);margin:0}
  select.theme-select{background:var(--card);color:var(--ink);border:1px solid var(--border);padding:8px 10px;border-radius:10px;font-weight:600;cursor:pointer}

  main{padding:14px;display:grid;gap:14px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
  h2{font-size:16px;margin:0 0 12px 0}
  h3{font-size:15px;margin:0 0 8px 0;color:var(--muted)}
  label{display:block;margin-bottom:6px;font-size:13px;color:var(--muted)}
  input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0f0f0f;color:var(--ink);font-size:15px}
  input[type="number"]{text-align:right}
  /* HIDE number spinners */
  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button{ -webkit-appearance:none; margin:0; }
  input[type=number]{ -moz-appearance:textfield; }

  /* Compact widths */
  .fee-input{ max-width:90px; }
  .pct-input{ max-width:70px; }

  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row-inline{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}

  /* Extra space for totals/fee lines */
  .row.totals{ grid-template-columns: 1fr auto; gap:20px; align-items:end; }
  @media (max-width:560px){
    .row.totals{ grid-template-columns:1fr; }
    .fee-input{ max-width:100%; }
  }

  .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--border);color:var(--ink);background:#0f0f0f;font-weight:700;cursor:pointer}
  .btn-accent{background:var(--accent);color:#111;border-color:#ffecb3}
  .btn-danger{background:#2a1212;color:#ffd1d1;border-color:#441b1b}
  .stack{display:grid;gap:10px}
  .list{border:1px dashed var(--border);border-radius:10px;padding:8px;display:grid;gap:6px}

  /* Percent row layout (no overlaps) */
  .row-list{
    display:grid;
    grid-template-columns:1fr 80px auto; /* name | % | clear */
    gap:8px; align-items:center; transition:transform .08s ease;
  }
  @media (max-width:560px){
    .row-list{ grid-template-columns:1fr 80px; }
    .row-list .inline{ grid-column:1 / -1; }
  }
  .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:#101010;color:var(--muted);transition:border-color .15s ease, box-shadow .15s ease}
  .row-list.active .pill{border-color:var(--accent); box-shadow:0 0 0 2px rgba(255,213,79,.2)}
  .row-list.active input{outline:2px solid rgba(255,213,79,.2); border-color:var(--accent)}
  .row-list.active{transform:scale(1.01)}
  .pill.inactive{opacity:.7}

  .toolbar{display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap;margin-top:6px}

  table{width:100%;border-collapse:collapse;overflow-x:auto;display:block}
  th,td{padding:8px;border-bottom:1px solid var(--border);text-align:right;white-space:nowrap}
  th:first-child,td:first-child{text-align:left;position:sticky;left:0;background:var(--card)}
  tfoot td{font-weight:800}
  #days-table{overflow-x:auto}

  .footer{color:var(--muted);font-size:12px;text-align:center;padding:14px}
  .inline{display:inline-flex;gap:8px;align-items:center;flex-wrap:wrap}
  .hint{font-size:12px;color:var(--muted)}
  .dim{color:var(--muted)}
  .warn{color:#ffb3b3}
  .shift-tabs{display:flex;gap:6px;margin-top:8px}
  .shift-tabs button{background:#0f0f0f;border:1px solid var(--border);color:var(--ink);padding:8px 12px;border-radius:999px;cursor:pointer}
  .shift-tabs button.active{background:var(--accent);color:#111;border-color:#ffecb3}

  /* Overlays + calendar */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:99}
  .panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;width:360px;max-width:95vw;color:var(--ink)}
  .panel header{display:flex;align-items:center;justify-content:space-between;padding:0 0 8px 0}
  .panel .title{font-weight:700}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cal-day,.cal-wd{text-align:center;padding:8px 0}
  .cal-wd{color:var(--muted);font-size:12px}
  .cal-day{border:1px solid var(--border);border-radius:8px;background:#101010;display:flex;align-items:center;justify-content:center;min-height:36px}
  .btnlike{cursor:pointer}
  .cal-day:hover{outline:2px solid var(--accent)}
  .cal-today{border-color:var(--accent)}
  .cal-btn{background:none;border:1px solid var(--border);color:var(--ink);padding:6px 10px;border-radius:8px;cursor:pointer}
  .close-x{background:none;border:none;color:var(--ink);font-size:20px;cursor:pointer}
  .panel-actions{display:flex;gap:8px;justify-content:space-between;margin-top:8px}
  .icon-cal{font-size:22px;line-height:1;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#000;color:#fff;cursor:pointer}

  /* Calendar selection highlight */
  .cal-disabled{opacity:.45;filter:grayscale(0.3);cursor:not-allowed !important;position:relative;}
  .cal-disabled::after{content:"saved";position:absolute;bottom:4px;right:6px;font-size:10px;color:var(--muted);}
  .cal-selected{
    outline: 2px solid var(--accent);
    box-shadow: 0 0 0 2px rgba(255,213,79,.25) inset;
    background: #151515;
  }

  /* PRINT */
  @media print{
    :root{color-scheme:light}
    html,body{background:#fff !important;color:#000 !important;font-size:12pt}
    header,nav,.footer,.icon-cal,.btn,.hint{display:none !important}
    input,select{background:#fff !important;color:#000 !important;border:1px solid #000 !important}
    main{padding:0 !important}
    .card{border:none !important;box-shadow:none !important;background:#fff !important}
    #view-staff,#view-entries,#view-summary,#view-backup{display:none !important}
    body.print-entries #view-entries{display:block !important}
    body.print-entries #view-entries::before{
      content:"Dagennaro Restaurant";
      display:block;text-align:center;font-size:1.8em;font-weight:700;margin:6mm 0
    }
    body.print-entries h3:has(+ #lunch-pct-list),
    body.print-entries #lunch-pct-list,
    body.print-entries #lunch-pct-warning,
    body.print-entries h3:has(+ #dinner-pct-list),
    body.print-entries #dinner-pct-list,
    body.print-entries #dinner-pct-warning{
      display:none !important;
    }
    body.print-summary #view-summary{display:block !important}
    body.print-summary #summary-output::before{
      content:"Dagennaro Restaurant";
      display:block;text-align:center;font-size:1.8em;font-weight:700;margin:6mm 0
    }
    table{width:100% !important;border-collapse:collapse !important;display:table !important}
    th,td{border:1px solid #000 !important;color:#000 !important;background:#fff !important;padding:6px !important}
    th:first-child,td:first-child{position:static !important;background:#fff !important;text-align:left !important}
    h1,h2,h3,label{color:#000 !important}
    .pill{border:1px solid #000 !important;color:#000 !important;background:#fff !important}
  
    /* --- Fix for columns getting cut off on print (iPad/WebKit) --- */
    table{ table-layout: fixed !important; max-width:100% !important; }
    th,td{ white-space: normal !important; word-break: break-word !important; }
    th,td{ padding:4px !important; } /* tighter to fit more columns */
    #summary-output table{ font-size: 11pt !important; }
}
</style>
</head>
<body>
<header>
  <div>
    <h1>Tip Pooler</h1>
    <small>Dagennaro Restaurant • 2 shifts/day • split by percent</small>
  </div>

  <div class="theme-wrap">
    <label for="theme-select">Theme</label>
    <select id="theme-select" class="theme-select">
      <option value="dark" selected>Dark</option>
      <option value="light">Light</option>
      <option value="blue">Blue</option>
      <option value="green">Green</option>
      <option value="red">Red</option>
      <option value="purple">Purple</option>
    </select>
  </div>

  <nav>
    <button id="tab-staff" class="active">Staff</button>
    <button id="tab-entries">Entries</button>
    <button id="tab-summary">Summary</button>
    <button id="tab-backup">Backup</button>
  </nav>
</header>

<main>
  <!-- STAFF -->
  <section id="view-staff" class="card">
    <h2>Team</h2>
    <div class="row">
      <div>
        <label>New staff name</label>
        <input id="staff-name" placeholder="e.g., Maria" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn btn-accent" id="add-staff">Add</button>
      </div>
    </div>
    <div>
      <h3>Current staff</h3>
      <div id="staff-list" class="list"></div>
      <div class="hint">Delete won’t change past days.</div>
    </div>
  </section>

  <!-- ENTRIES -->
  <section id="view-entries" class="card" style="display:none">
    <h2>Daily entry</h2>
    <div class="stack">
      <div class="row">
        <div>
          <label>Date</label>
          <div class="row-inline">
            <input id="entry-date" class="date-field" type="date" />
            <button class="icon-cal" data-target="entry-date">📅</button>
          </div>
        </div>
        <div class="inline" style="align-self:end">
          <button class="btn" id="print-day">Print day</button>
          <button class="btn btn-danger" id="cancel-edit" style="display:none">Cancel edit</button>
        </div>
      </div>

      <div class="shift-tabs">
        <button id="btn-lunch" class="active">Lunch</button>
        <button id="btn-dinner">Dinner</button>
      </div>

      <div id="panel-lunch" class="stack">
        <h3>Lunch</h3>
        <div class="row totals">
          <div>
            <label>Lunch total tips ($, gross)</label>
            <input id="lunch-total" type="number" step="0.01" min="0" placeholder="0.00" />
          </div>
          <div>
            <label>Credit card fee ($)</label>
            <input id="lunch-ccfee" type="number" step="0.01" min="0" placeholder="0.00" class="fee-input" />
          </div>
        </div>
        <div class="hint" id="lunch-net-hint">Net = $0.00 (gross $0.00 – fee $0.00)</div>
        <div>
          <h3>Lunch — Percent by staff</h3>
          <div class="toolbar">
            <button class="btn btn-danger" id="clear-lunch">Clear All</button>
          </div>
          <div id="lunch-pct-list" class="list"></div>
          <div class="warn" id="lunch-pct-warning" style="display:none">Percent must be 1–100. Totals auto-normalize.</div>
        </div>
        <div id="lunch-preview-output" class="stack"></div>
      </div>

      <div id="panel-dinner" class="stack" style="display:none">
        <h3>Dinner</h3>
        <div class="row totals">
          <div>
            <label>Dinner total tips ($, gross)</label>
            <input id="dinner-total" type="number" step="0.01" min="0" placeholder="0.00" />
          </div>
          <div>
            <label>Credit card fee ($)</label>
            <input id="dinner-ccfee" type="number" step="0.01" min="0" placeholder="0.00" class="fee-input" />
          </div>
        </div>
        <div class="hint" id="dinner-net-hint">Net = $0.00 (gross $0.00 – fee $0.00)</div>
        <div>
          <h3>Dinner — Percent by staff</h3>
          <div class="toolbar">
            <button class="btn btn-danger" id="clear-dinner">Clear All</button>
          </div>
          <div id="dinner-pct-list" class="list"></div>
          <div class="warn" id="dinner-pct-warning" style="display:none">Percent must be 1–100. Totals auto-normalize.</div>
        </div>
        <div id="dinner-preview-output" class="stack"></div>
      </div>

      <div class="inline">
        <button class="btn btn-accent" id="save-entry">Save day</button>
        <button class="btn" id="view-days">View saved days</button>
      </div>

      <div id="days-table"></div>
      <div class="hint">Save just Lunch, just Dinner, or both — whatever you fill in.</div>
    </div>
  </section>

  <!-- SUMMARY -->
  <section id="view-summary" class="card" style="display:none">
    <h2>Weekly summary</h2>
    <div class="row">
      <div>
        <label>Pick any date in the week</label>
        <div class="row-inline">
          <input id="sum-date" class="date-field" type="date" />
          <button class="icon-cal" data-target="sum-date">📅</button>
        </div>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn btn-accent" id="calc-week">Calculate</button>
        <button class="btn" id="print-summary">Print summary</button>
      </div>
    </div>

    <div id="summary-output" style="margin-top:12px"></div>
  </section>

  <!-- BACKUP -->
  <section id="view-backup" class="card" style="display:none">
    <h2>Backup & restore</h2>
    <div class="stack">
      <div class="inline">
        <button class="btn" id="export-json">Export JSON</button>
        <button class="btn" id="export-csv">Export CSV (week)</button>
        <button class="btn btn-danger" id="wipe-all">Erase all data</button>
      </div>
      <div>
        <label>Restore from JSON</label>
        <input id="import-json" type="file" accept=".json,application/json" />
      </div>
    
      <div>
        <label>Security code for edit/delete (4 digits)</label>
        <div class="stack" style="gap:8px">
          <div class="row-inline">
            <input id="sec-pin-current" type="password" inputmode="numeric" maxlength="4" placeholder="Current code" class="fee-input" />
          </div>
          <div class="row-inline">
            <input id="sec-pin-new" type="password" inputmode="numeric" maxlength="4" placeholder="New 4-digit code (leave blank to disable)" class="fee-input" />
            <input id="sec-pin-new2" type="password" inputmode="numeric" maxlength="4" placeholder="Confirm new code" class="fee-input" />
          </div>
          <div class="row-inline">
            <button class="btn" id="save-sec-pin">Save code</button>
          </div>
        </div>
        <div class="hint">Changing or disabling the code requires the <b>current</b> 4-digit code.</div>
      </div>
    </div>
  </section>
</main>

<!-- Calendar overlay -->
<div class="overlay" id="cal-ovl">
  <div class="panel">
    <header>
      <button class="cal-btn" id="cal-prev">◀</button>
      <div class="title" id="cal-title">Month YYYY</div>
      <button class="cal-btn" id="cal-next">▶</button>
      <button class="close-x" id="cal-close">✕</button>
    </header>
    <div class="cal-grid" id="cal-grid-wd"></div>
    <div class="cal-grid" id="cal-grid"></div>
    <div class="panel-actions">
      <button class="cal-btn" id="cal-today">Today</button>
      <button class="btn btn-accent" id="cal-apply">Use Date</button>
    </div>
  </div>
</div>

<!-- Payouts overlay -->
<div class="overlay" id="payouts-ovl">
  <div class="panel" style="width:360px;">
    <header>
      <div class="title" id="payouts-title">Payouts</div>
      <button class="close-x" id="payouts-close">✕</button>
    </header>
    <div id="payouts-body"></div>
    <div class="panel-actions">
      <button class="btn btn-accent" id="payouts-copy">Copy</button>
    </div>
  </div>
</div>

<div class="footer">Everything is saved locally on your device • No sign-in needed</div>

<script>
const $ = q => document.querySelector(q);
const $$ = q => document.querySelectorAll(q);

// === Edit-mode UI helper ===
function setEditMode(on){
  const cancelBtn = document.getElementById('cancel-edit');
  if(cancelBtn){
    cancelBtn.style.display = on ? 'inline-block' : 'none';
  }
}


// Storage
const store = {
  get(){ try{ return JSON.parse(localStorage.getItem('tip_pooler_reset_ccfee_v2_edit')||'{}'); }catch(e){ return {}; } },
  set(d){ localStorage.setItem('tip_pooler_reset_ccfee_v2_edit', JSON.stringify(d)); },
  wipe(){ localStorage.removeItem('tip_pooler_reset_ccfee_v2_edit'); }
};

// State
const state = Object.assign({
  staff: [],                     // [{id,name,active:true}]
  settings: { weekStart: 1 },    // Monday
  entries: []                    // [{date, shifts:{lunch:{gross,fee,total,pcts,staffNames}, dinner:{...}} , payoutsByShift, payouts}]
}, store.get());
function persist(){ store.set(state); }

// THEME
(function initTheme(){
  const saved = state.settings && state.settings.theme ? state.settings.theme : 'dark';
  document.body.classList.remove('theme-dark','theme-light','theme-blue','theme-green','theme-red','theme-purple');
  document.body.classList.add('theme-' + saved);
  const sel = document.getElementById('theme-select');
  if(sel){ sel.value = saved; }
})();
document.getElementById('theme-select').addEventListener('change',(e)=>{
  const val = e.target.value;
  document.body.classList.remove('theme-dark','theme-light','theme-blue','theme-green','theme-red','theme-purple');
  document.body.classList.add('theme-' + val);
  state.settings = state.settings || {};
  state.settings.theme = val;
  persist();
});

// Tabs
[['tab-staff','view-staff'],['tab-entries','view-entries'],['tab-summary','view-summary'],['tab-backup','view-backup']]
.forEach(([btn,view])=>{
  document.getElementById(btn).onclick = ()=>{
    ['view-staff','view-entries','view-summary','view-backup'].forEach(v=>{
      document.getElementById(v).style.display = (v===view)?'block':'none';
    });
    ['tab-staff','tab-entries','tab-summary','tab-backup'].forEach(b=>{
      document.getElementById(b).classList.toggle('active', b===btn);
    });
  };
});

// Shift tabs (also CLEAR the panel when switching)
function clearPanel(which){
  const scope = which==='lunch' ? '#panel-lunch' : '#panel-dinner';
  document.querySelectorAll(scope+' .pct-input').forEach(i=> i.value='');
  document.querySelectorAll(scope+' .row-list').forEach(r=> r.classList.remove('active'));
  if(which==='lunch'){ $('#lunch-total').value=''; $('#lunch-ccfee').value=''; }
  else{ $('#dinner-total').value=''; $('#dinner-ccfee').value=''; }
  renderPreview();
}
$('#btn-lunch').onclick = ()=>{
  clearPanel('lunch');
  $('#btn-lunch').classList.add('active'); $('#btn-dinner').classList.remove('active');
  $('#panel-lunch').style.display='grid'; $('#panel-dinner').style.display='none';
};
$('#btn-dinner').onclick = ()=>{
  clearPanel('dinner');
  $('#btn-dinner').classList.add('active'); $('#btn-lunch').classList.remove('active');
  $('#panel-dinner').style.display='grid'; $('#panel-lunch').style.display='none';
};

// STAFF (Alphabetical)
function renderStaff(){
  const list = $('#staff-list');
  list.innerHTML = '';
  if (state.staff.length===0){ list.innerHTML = '<div class="pill">No staff yet — add names above.</div>'; return; }
  const sorted = [...state.staff].sort((a,b)=> (a.name||'').toLowerCase().localeCompare((b.name||'').toLowerCase()));
  sorted.forEach(s=>{
    const row = document.createElement('div');
    row.className='row-list';
    row.innerHTML = `
      <input value="${s.name}" data-id="${s.id}" class="name-edit"/>
      <span class="pill">${s.active?'Active':'Inactive'}</span>
      <div class="inline">
        <button class="btn btn-danger" data-del="${s.id}">Delete</button>
        <button class="btn" data-menu="${s.id}">⋯</button>
      </div>`;
    row.querySelector('[data-del]').onclick=()=>{
      if(!confirm('Delete this staff? Past days will keep their name in history.')) return;
      state.staff = state.staff.filter(x=> String(x.id)!==String(s.id));
      persist(); renderStaff(); renderPctInputs();
    };
    row.querySelector('[data-menu]').onclick=()=>{
      const a=prompt('Type: rename or toggle','toggle'); if(!a) return;
      if(a.toLowerCase().startsWith('ren')){ const n=prompt('New name', s.name); if(n){ s.name=n.trim(); persist(); renderStaff(); renderPctInputs(); } }
      else if(a.toLowerCase().startsWith('tog')){ s.active=!s.active; persist(); renderStaff(); renderPctInputs(); }
    };
    row.querySelector('.name-edit').onchange=(e)=>{ s.name=e.target.value.trim(); persist(); renderStaff(); renderPctInputs(); };
    list.appendChild(row);
  });
}
$('#add-staff').onclick=()=>{
  const name=$('#staff-name').value.trim(); if(!name) return alert('Enter a name');
  const id=Date.now()+Math.floor(Math.random()*1000);
  state.staff.push({id,name,active:true});
  $('#staff-name').value=''; persist(); renderStaff(); renderPctInputs();
};

// Auto-capitalize while typing in staff-name input
$('#staff-name').addEventListener('input', (e) => {
  let v = e.target.value;
  if(v.length > 0){
    e.target.value = v.charAt(0).toUpperCase() + v.slice(1);
  }
});
renderStaff();

/* --- Helpers for % inputs --- */
function clampPercentInput(el){
  const raw = el.value.trim();
  if(raw===''){ return ''; }
  let n = Math.floor(Number(raw.replace(/[^\d.]/g,'')));
  if(!isFinite(n)){ n=''; }
  else{
    if(n < 1) n = 1;
    if(n > 100) n = 100;
  }
  el.value = n === '' ? '' : String(n);
  return el.value;
}
function setRowActive(row, isActive){
  row.classList.toggle('active', !!isActive);
}
function clearAllInputs(){
  setEditMode(false); window.editContext = null; document.querySelectorAll('.pct-input').forEach(i=> i.value='');
  document.querySelectorAll('.row-list').forEach(r=> r.classList.remove('active'));
  $('#lunch-total').value=''; $('#lunch-ccfee').value='';
  $('#dinner-total').value=''; $('#dinner-ccfee').value='';
  renderPreview();
}

// ENTRIES – % inputs (Alphabetical for active staff)
function renderPctInputs(){
  const active = [...state.staff.filter(s=> s.active)].sort((a,b)=> (a.name||'').toLowerCase().localeCompare((b.name||'').toLowerCase()));

  function renderList(containerId){
    const list = $(containerId); list.innerHTML='';
    if(active.length===0){ list.innerHTML='<div class="pill">No active staff — activate some on the Staff tab.</div>'; return; }

    active.forEach(s=>{
      const row=document.createElement('div'); row.className='row-list';
      row.innerHTML = `
        <div class="pill">${s.name}</div>
        <input type="number" step="1" min="1" max="100" placeholder="%" data-id="${s.id}" class="pct-input">
        <div class="inline"><button class="btn" data-id="${s.id}">Clear</button></div>`;

      const input = row.querySelector('.pct-input');
      const clearBtn = row.querySelector('button');

      input.addEventListener('focus', ()=> setRowActive(row, true));
      input.addEventListener('blur', ()=> { if((input.value||'').trim()===''){ setRowActive(row, false); } });
      input.addEventListener('input', ()=>{
        const v = clampPercentInput(input);
        setRowActive(row, v !== '' && Number(v) >= 1);
        renderPreview();
      });
      clearBtn.onclick = ()=>{ input.value=''; setRowActive(row, false); renderPreview(); };

      list.appendChild(row);
    });
  }

  renderList('#lunch-pct-list');
  renderList('#dinner-pct-list');
}
renderPctInputs();

// Clear All buttons
$('#clear-lunch').onclick=()=> {
  $('#lunch-pct-list').querySelectorAll('.pct-input').forEach(i=> i.value='');
  $('#lunch-pct-list').querySelectorAll('.row-list').forEach(r=> r.classList.remove('active'));
  renderPreview();
};
$('#clear-dinner').onclick=()=> {
  $('#dinner-pct-list').querySelectorAll('.pct-input').forEach(i=> i.value='');
  $('#dinner-pct-list').querySelectorAll('.row-list').forEach(r=> r.classList.remove('active'));
  renderPreview();
};

// Auto-clear on date change
$('#entry-date').addEventListener('change', clearAllInputs);

// Preview + Net hints
function buildRows(containerId){
  const rows=[]; let totalPct=0;
  $(`${containerId}`).querySelectorAll('.pct-input').forEach(i=>{
    const pct=parseFloat(i.value);
    if(isFinite(pct) && pct>=1 && pct<=100){
      totalPct+=pct;
      const sid=i.dataset.id; const staff=state.staff.find(s=> String(s.id)===String(sid));
      rows.push({sid,name:(staff?staff.name:('#'+sid)),pct});
    }
  });
  return {rows,totalPct};
}
function updateNetHints(){
  const lg=+($('#lunch-total').value||0), lf=+($('#lunch-ccfee').value||0);
  const ln=Math.max(0,(isFinite(lg)?lg:0)-(isFinite(lf)?lf:0));
  $('#lunch-net-hint').textContent = `Net = $${ln.toFixed(2)} (gross $${(lg||0).toFixed(2)} – fee $${(lf||0).toFixed(2)})`;

  const dg=+($('#dinner-total').value||0), df=+($('#dinner-ccfee').value||0);
  const dn=Math.max(0,(isFinite(dg)?dg:0)-(isFinite(df)?df:0));
  $('#dinner-net-hint').textContent = `Net = $${dn.toFixed(2)} (gross $${(dg||0).toFixed(2)} – fee $${(df||0).toFixed(2)})`;
}
function renderPreview(){
  updateNetHints();

  // Lunch
  const lunchGross=+($('#lunch-total').value||0);
  const lunchFee=+($('#lunch-ccfee').value||0);
  const lunchNet=Math.max(0,(isFinite(lunchGross)?lunchGross:0)-(isFinite(lunchFee)?lunchFee:0));
  const L=buildRows('#lunch-pct-list'); let htmlL='';
  if(L.rows.length){
    htmlL+='<h3>Lunch split (preview)</h3>';
    htmlL+=`<div class="dim">Split base $${lunchNet.toFixed(2)}${(isFinite(lunchFee)&&lunchFee>0?` (after $${Number(lunchFee).toFixed(2)} fee)`:``)}.</div>`;
    htmlL+='<table><thead><tr><th>Staff</th><th>%</th><th>Payout ($)</th></tr></thead><tbody>';
    L.rows.forEach(r=>{
      const share = L.totalPct>0 ? lunchNet*(r.pct/L.totalPct) : 0;
      htmlL+=`<tr><td>${r.name}</td><td>${r.pct.toFixed(0)}%</td><td>${share.toFixed(2)}</td></tr>`;
    });
    htmlL+=`</tbody><tfoot><tr><td>Total</td><td>${(Math.round(L.totalPct)).toFixed(0)}%</td><td>${lunchNet.toFixed(2)}</td></tr></tfoot></table>`;
  }
  $('#lunch-preview-output').innerHTML=htmlL;

  // Dinner
  const dinnerGross=+($('#dinner-total').value||0);
  const dinnerFee=+($('#dinner-ccfee').value||0);
  const dinnerNet=Math.max(0,(isFinite(dinnerGross)?dinnerGross:0)-(isFinite(dinnerFee)?dinnerFee:0));
  const D=buildRows('#dinner-pct-list'); let htmlD='';
  if(D.rows.length){
    htmlD+='<h3>Dinner split (preview)</h3>';
    htmlD+=`<div class="dim">Split base $${dinnerNet.toFixed(2)}${(isFinite(dinnerFee)&&dinnerFee>0?` (after $${Number(dinnerFee).toFixed(2)} fee)`:``)}.</div>`;
    htmlD+='<table><thead><tr><th>Staff</th><th>%</th><th>Payout ($)</th></tr></thead><tbody>';
    D.rows.forEach(r=>{
      const share = D.totalPct>0 ? dinnerNet*(r.pct/D.totalPct) : 0;
      htmlD+=`<tr><td>${r.name}</td><td>${r.pct.toFixed(0)}%</td><td>${share.toFixed(2)}</td></tr>`;
    });
    htmlD+=`</tbody><tfoot><tr><td>Total</td><td>${(Math.round(D.totalPct)).toFixed(0)}%</td><td>${dinnerNet.toFixed(2)}</td></tr></tfoot></table>`;
  }
  $('#dinner-preview-output').innerHTML=htmlD;
}
$('#lunch-total').oninput=renderPreview;
$('#lunch-ccfee').oninput=renderPreview;
$('#dinner-total').oninput=renderPreview;
$('#dinner-ccfee').oninput=renderPreview;

// ===== EDIT MODE =====
let editContext = null; // { originalDate: 'YYYY-MM-DD' }

function nameById(id){
  const s = state.staff.find(x=> String(x.id)===String(id));
  return s ? s.name : null;
}
function ensurePctRow(containerId, sid, label, inactive=false){
  const container = $(containerId);
  let input = container.querySelector(`.pct-input[data-id="${sid}"]`);
  if(!input){
    const row=document.createElement('div'); row.className='row-list';
    row.innerHTML = `
      <div class="pill ${inactive?'inactive':''}">${label}${inactive?' (inactive)':''}</div>
      <input type="number" step="1" min="1" max="100" placeholder="%" data-id="${sid}" class="pct-input">
      <div class="inline"><button class="btn" data-id="${sid}">Clear</button></div>`;
    input = row.querySelector('.pct-input');
    const clearBtn = row.querySelector('button');
    input.addEventListener('focus', ()=> setRowActive(row, true));
    input.addEventListener('blur', ()=> { if((input.value||'').trim()===''){ setRowActive(row, false); } });
    input.addEventListener('input', ()=>{ const v = clampPercentInput(input); setRowActive(row, v!=='' && Number(v)>=1); renderPreview(); });
    clearBtn.onclick = ()=>{ input.value=''; setRowActive(row,false); renderPreview(); };
    container.appendChild(row);
  }
  return input;
}

function loadEntryForEdit(dateStr){
  const entry = state.entries.find(e=> e.date===dateStr);
  if(!entry){ alert('Could not find this day.'); return; }

  // Switch to Entries tab & show panel
  document.getElementById('tab-entries').click();

  // Fill date & totals/fees
  $('#entry-date').value = entry.date || '';
  const L = entry.shifts?.lunch || {};
  const D = entry.shifts?.dinner || {};
  $('#lunch-total').value = L.gross ?? '';
  $('#lunch-ccfee').value = L.fee ?? '';
  $('#dinner-total').value = D.gross ?? '';
  $('#dinner-ccfee').value = D.fee ?? '';

  // Re-render inputs fresh
  renderPctInputs();

  // Apply % values, including inactive/removed staff
  const lunchNames = (L.staffNames)||{};
  const dinnerNames = (D.staffNames)||{};

  Object.entries(L.pcts||{}).forEach(([sid,pct])=>{
    const label = lunchNames[sid] || nameById(sid) || ('#'+sid);
    const inactive = !nameById(sid);
    const input = ensurePctRow('#lunch-pct-list', sid, label, inactive);
    input.value = pct;
    setRowActive(input.closest('.row-list'), true);
  });

  Object.entries(D.pcts||{}).forEach(([sid,pct])=>{
    const label = dinnerNames[sid] || nameById(sid) || ('#'+sid);
    const inactive = !nameById(sid);
    const input = ensurePctRow('#dinner-pct-list', sid, label, inactive);
    input.value = pct;
    setRowActive(input.closest('.row-list'), true);
  });

  renderPreview();

  // Enter edit mode
  editContext = { originalDate: entry.date };
  $('#save-entry').textContent = 'Update day';
  $('#cancel-edit').style.display = 'inline-block';
}

$('#cancel-edit').onclick = ()=>{
  editContext = null;
  $('#save-entry').textContent = 'Save day';
  $('#cancel-edit').style.display = 'none';
  clearAllInputs();
  renderPctInputs();
  renderPreview();
};

// Save / Update day

$('#cancel-edit').onclick=()=>{
  // existing behavior: just exit edit mode and clear (if any)
  window.editContext = null;
  // auto-advance next day on cancel (if next day not already saved)
  try{
    const dateStr = document.getElementById('entry-date') ? document.getElementById('entry-date').value : '';
    if(dateStr){
      const [Y,M,D] = dateStr.split('-').map(x=>+x);
      const cur = new Date(Y, (M||1)-1, D||1);
      const next = new Date(cur); next.setDate(cur.getDate()+1);
      const nextStr = `${next.getFullYear()}-${String(next.getMonth()+1).padStart(2,'0')}-${String(next.getDate()).padStart(2,'0')}`;
      const existsNext = (state.entries||[]).some(e=> e.date===nextStr);
      if(!existsNext){
        const entryDateEl = document.getElementById('entry-date');
        if(entryDateEl){
          entryDateEl.value = nextStr;
          clearAllInputs();
          renderCalendar();
        }
      }
    }
  }catch(e){}
};
$('#save-entry').onclick=()=>{
  const date=$('#entry-date').value; if(!date) return alert('Pick a date');
  // if date exists and we're not in edit mode, treat this as editing that date (so lunch/dinner can be updated later)
  const _exists = (state.entries||[]).some(e=> e.date===date);
  if((!window.editContext || window.editContext.originalDate!==date) && _exists){
    window.editContext = { originalDate: date };
  }


  const lunchGross=+($('#lunch-total').value||0);
  const lunchFee=+($('#lunch-ccfee').value||0);
  const lunchNet=Math.max(0,(isFinite(lunchGross)?lunchGross:0)-(isFinite(lunchFee)?lunchFee:0));

  const dinnerGross=+($('#dinner-total').value||0);
  const dinnerFee=+($('#dinner-ccfee').value||0);
  const dinnerNet=Math.max(0,(isFinite(dinnerGross)?dinnerGross:0)-(isFinite(dinnerFee)?dinnerFee:0));

  const lunchPcts={}, lunchNames={};
  $('#lunch-pct-list').querySelectorAll('.pct-input').forEach(i=>{
    const v=+i.value;
    if(isFinite(v)&&v>=1&&v<=100){
      lunchPcts[i.dataset.id]=v;
      const nm = i.closest('.row-list').querySelector('.pill').textContent.replace(' (inactive)','');
      lunchNames[i.dataset.id]=nm;
    }
  });

  const dinnerPcts={}, dinnerNames={};
  $('#dinner-pct-list').querySelectorAll('.pct-input').forEach(i=>{
    const v=+i.value;
    if(isFinite(v)&&v>=1&&v<=100){
      dinnerPcts[i.dataset.id]=v;
      const nm = i.closest('.row-list').querySelector('.pill').textContent.replace(' (inactive)','');
      dinnerNames[i.dataset.id]=nm;
    }
  });

  if(!(isFinite(lunchGross)&&lunchGross>0) && !(isFinite(dinnerGross)&&dinnerGross>0)) return alert('Enter tips for Lunch or Dinner.');
  if((isFinite(lunchGross)&&lunchGross>0) && Object.keys(lunchPcts).length===0) return alert('Enter at least one % for Lunch (1–100).');
  if((isFinite(dinnerGross)&&dinnerGross>0) && Object.keys(dinnerPcts).length===0) return alert('Enter at least one % for Dinner (1–100).');

  function computePayouts(total,pcts){
    const out={}; const sumPct=Object.values(pcts||{}).reduce((a,b)=>a+Number(b),0)||0;
    if(sumPct<=0 || !(isFinite(total)&&total>0)) return out;
    Object.entries(pcts).forEach(([sid,p])=>{ const share=total*(Number(p)/sumPct); out[sid]=(out[sid]||0)+Math.round(share*100)/100; });
    return out;
  }

  const shifts={}, payoutsByShift={};
  if(isFinite(lunchGross)&&lunchGross>0){
    shifts.lunch={gross:lunchGross,fee:(isFinite(lunchFee)?lunchFee:0),total:lunchNet,pcts:lunchPcts,staffNames:lunchNames};
    payoutsByShift.lunch=computePayouts(lunchNet,lunchPcts);
  }
  if(isFinite(dinnerGross)&&dinnerGross>0){
    shifts.dinner={gross:dinnerGross,fee:(isFinite(dinnerFee)?dinnerFee:0),total:dinnerNet,pcts:dinnerPcts,staffNames:dinnerNames};
    payoutsByShift.dinner=computePayouts(dinnerNet,dinnerPcts);
  }

  const payouts={}; ['lunch','dinner'].forEach(sh=>{ Object.entries(payoutsByShift[sh]||{}).forEach(([sid,amt])=> payouts[sid]=(payouts[sid]||0)+amt); });

  // If editing and the date changed, remove the original; then upsert
  if(editContext && editContext.originalDate){
    state.entries = state.entries.filter(e=> e.date!==editContext.originalDate);
  }else{
    state.entries = state.entries.filter(e=> e.date!==date);
  }
  state.entries.push({date,shifts,payoutsByShift,payouts});
  persist();

  // Exit edit mode
  editContext = null;
  $('#save-entry').textContent = 'Save day';
  $('#cancel-edit').style.display = 'none';

  alert('Saved!');
  if(daysVisible){ renderDaysTable(); }

  /* auto-advance to next day after dinner */
  try{
    const dparts = (date||'').split('-');
    if(dparts.length===3){
      const Y = +dparts[0], M = +dparts[1]-1, D = +dparts[2];
      const cur = new Date(Y, M, D);
      const next = new Date(cur); next.setDate(cur.getDate()+1);
      const nextStr = `${next.getFullYear()}-${String(next.getMonth()+1).padStart(2,'0')}-${String(next.getDate()).padStart(2,'0')}`;
      // consider dinner "made" if dinner total or any dinner percentages exist
      const dinnerMade = (isFinite(dinnerGross) && dinnerGross>0) || (Object.keys(dinnerPcts||{}).length>0);
      if(dinnerMade){
        const existsNext = (state.entries||[]).some(e=> e.date===nextStr);
        if(!existsNext){
          const entryDateEl = document.getElementById('entry-date');
          if(entryDateEl){
            entryDateEl.value = nextStr;
            window.editContext = null;
            clearAllInputs();
            renderCalendar();
          }
        }
      }
    }
  }catch(e){}

};

// Saved days toggle + table rendering (with Edit button)
let daysVisible = false;
$('#view-days').onclick=()=>{
  if(!daysVisible){
    renderDaysTable();
    $('#days-table').style.display = 'block';
    $('#view-days').textContent = 'Hide saved days';
    daysVisible = true;
  }else{
    $('#days-table').style.display = 'none';
    $('#view-days').textContent = 'View saved days';
    daysVisible = false;
  }
};
function renderDaysTable(){
  const div=$('#days-table');
  if(state.entries.length===0){ div.innerHTML='<div class="pill">No saved days yet.</div>'; return; }
  const rows=[...state.entries].sort((a,b)=> b.date.localeCompare(a.date));
  let html='<table><thead><tr><th>Date</th><th>Lunch $</th><th>Dinner $</th><th>Total $</th><th></th><th></th><th></th></tr></thead><tbody>';
  rows.forEach(e=>{
    const L=e.shifts?.lunch?.total||0, D=e.shifts?.dinner?.total||0;
    html+=`<tr>
      <td>${e.date}</td>
      <td>${Number(L).toFixed(2)}</td>
      <td>${Number(D).toFixed(2)}</td>
      <td>${(L+D).toFixed(2)}</td>
      <td><button class="btn" data-edit="${e.date}">Edit</button></td>
      <td><button class="btn" data-view="${e.date}">Payouts</button></td>
      <td><button class="btn btn-danger" data-date="${e.date}">Delete</button></td>
    </tr>`;
  });
  html+='</tbody></table>'; div.innerHTML=html;
  div.querySelectorAll('[data-date]').forEach(b=> b.onclick=()=>{ if(!confirm('Delete this day?'))return; state.entries=state.entries.filter(e=>e.date!==b.dataset.date); persist(); if(daysVisible){ renderDaysTable(); } });
  div.querySelectorAll('[data-view]').forEach(b=> b.onclick=()=> openPayoutsFor(b.dataset.view));
  div.querySelectorAll('[data-edit]').forEach(b=> b.onclick=()=> loadEntryForEdit(b.dataset.edit));
}

// --- Enforce PIN on Edit/Delete (post-bind override) ---
(function(){
  const _origRenderDaysTable = renderDaysTable;
  renderDaysTable = function(){
    _origRenderDaysTable();
    const div = document.getElementById('days-table');
    if(!div) return;

    // Rebind DELETE with PIN
    div.querySelectorAll('[data-date]').forEach(b=>{
      b.onclick = ()=>{
        if(!requirePin()) return alert('Wrong or missing code.');
        if(!confirm('Delete this day?')) return;
        state.entries = state.entries.filter(e=> e.date !== b.dataset.date);
        persist();
        if(daysVisible){ renderDaysTable(); }
      };
    });

    // Rebind EDIT with PIN
    div.querySelectorAll('[data-edit]').forEach(b=>{
      b.onclick = ()=>{
        if(!requirePin()) return alert('Wrong or missing code.');
        loadEntryForEdit(b.dataset.edit);
      };
    });
  };
})();

// start hidden
(function(){ $('#days-table').style.display='none'; $('#view-days').textContent='View saved days'; daysVisible=false; })();

// SUMMARY
function wdName(dateStr){ const d=new Date(dateStr+'T00:00:00'); return ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()]; }
function weekRange(anyDateStr,weekStart=1){
  const d=new Date(anyDateStr+'T00:00:00'); if(isNaN(d)) return null;
  const day=d.getDay(); let diff=day-weekStart; if(diff<0) diff+=7;
  const start=new Date(d); start.setDate(d.getDate()-diff);
  const end=new Date(start); end.setDate(start.getDate()+6);
  const fmt2=x=>x.toISOString().slice(0,10); return {start:fmt2(start),end:fmt2(end)};
}
$('#calc-week').onclick=()=>{
  const d=$('#sum-date').value; if(!d) return alert('Pick a date');
  const {start,end}=weekRange(d,state.settings.weekStart||1);
  const entries=state.entries.filter(e=> e.date>=start && e.date<=end).sort((a,b)=> a.date.localeCompare(b.date));
  if(entries.length===0){ $('#summary-output').innerHTML='<div class="pill">No entries in this week.</div>'; return; }

  const dates=entries.map(e=>e.date);
  const lunchByDate=Object.fromEntries(dates.map(dt=>[dt,0]));
  const dinnerByDate=Object.fromEntries(dates.map(dt=>[dt,0]));
  entries.forEach(e=>{ lunchByDate[e.date]+=Number(e.shifts?.lunch?.total||0); dinnerByDate[e.date]+=Number(e.shifts?.dinner?.total||0); });

  const staffIds=new Set();
  entries.forEach(e=>{
    if(e.shifts?.lunch) Object.keys(e.shifts.lunch.pcts||{}).forEach(id=>staffIds.add(id));
    if(e.shifts?.dinner) Object.keys(e.shifts.dinner.pcts||{}).forEach(id=>staffIds.add(id));
  });
  const nameMap={}; state.staff.forEach(s=> nameMap[s.id]=s.name);

  const matrix={}; Array.from(staffIds).forEach(sid=>{ matrix[sid]={}; dates.forEach(dt=> matrix[sid][dt]=0); });
  dates.forEach(dt=>{
    const e=entries.find(x=>x.date===dt);
    if(e.shifts?.lunch && e.shifts.lunch.total>0){
      const L=e.shifts.lunch, sumPct=Object.values(L.pcts||{}).reduce((a,b)=>a+Number(b),0)||0;
      Object.entries(L.pcts||{}).forEach(([sid,p])=> matrix[sid][dt]+= sumPct>0? L.total*(Number(p)/sumPct):0 );
    }
    if(e.shifts?.dinner && e.shifts.dinner.total>0){
      const D=e.shifts.dinner, sumPct=Object.values(D.pcts||{}).reduce((a,b)=>a+Number(b),0)||0;
      Object.entries(D.pcts||{}).forEach(([sid,p])=> matrix[sid][dt]+= sumPct>0? D.total*(Number(p)/sumPct):0 );
    }
  });

  const totalsByStaff={}; Array.from(staffIds).forEach(sid=> totalsByStaff[sid]=dates.reduce((a,dt)=>a+(matrix[sid][dt]||0),0));

  let html=`<div class="pill">${start} → ${end}</div>`;
  html+='<h3>Daily tips by shift (NET)</h3>';
  html+='<table><thead><tr><th>Date</th><th>Lunch $</th><th>Dinner $</th><th>Total $</th></tr></thead><tbody>';
  dates.forEach(dt=>{ const wd=wdName(dt); const L=lunchByDate[dt]||0, D=dinnerByDate[dt]||0;
    html+=`<tr><td>${wd} ${dt}</td><td>${L.toFixed(2)}</td><td>${D.toFixed(2)}</td><td>${(L+D).toFixed(2)}</td></tr>`; });
  const weekLunch=dates.reduce((a,dt)=>a+(lunchByDate[dt]||0),0);
  const weekDinner=dates.reduce((a,dt)=>a+(dinnerByDate[dt]||0),0);
  const weekNet=weekLunch+weekDinner;
  html+=`</tbody><tfoot><tr><td>Weekly totals</td><td>${weekLunch.toFixed(2)}</td><td>${weekDinner.toFixed(2)}</td><td>${weekNet.toFixed(2)}</td></tr></tfoot></table>`;

  html+='<h3 style="margin-top:12px">Per-employee per-day payouts (Lunch + Dinner, NET)</h3>';
  html+='<table><thead><tr><th>Staff</th>';
  dates.forEach(dt=>{ const wd=wdName(dt); html+=`<th>${wd} ${dt}</th>`; });
  html+='<th>Total</th></tr></thead><tbody>';
  Array.from(staffIds).map(sid=>({sid,name:nameMap[sid]||('#'+sid),total:totalsByStaff[sid]}))
   .sort((a,b)=> a.name.localeCompare(b.name))
   .forEach(({sid,name,total})=>{
     html+=`<tr><td>${name}</td>`;
     dates.forEach(dt=> html+=`<td>${(matrix[sid][dt]||0).toFixed(2)}</td>`);
     html+=`<td>${total.toFixed(2)}</td></tr>`;
   });
  html+='<tfoot><tr><td>Total</td>';
  dates.forEach(dt=>{
    const colSum = Array.from(staffIds).reduce((acc,s)=> acc+(matrix[s][dt]||0), 0);
    html+=`<td>${colSum.toFixed(2)}</td>`;
  });
  html+=`<td>${weekNet.toFixed(2)}</td></tr></tfoot></table>`;
  $('#summary-output').innerHTML=html;
};

// PRINT (separated)
document.getElementById('print-summary').onclick=()=>{
  const view=document.getElementById('view-summary'); const old=view.style.display;
  document.body.classList.remove('print-entries'); document.body.classList.add('print-summary');
  view.style.display='block'; window.print();
  setTimeout(()=>{ document.body.classList.remove('print-summary'); view.style.display=old||'none'; },0);
};
document.getElementById('print-day').onclick=()=>{
  const view=document.getElementById('view-entries'); const old=view.style.display;
  document.body.classList.remove('print-summary'); document.body.classList.add('print-entries');
  view.style.display='block'; window.print();
  setTimeout(()=>{ document.body.classList.remove('print-entries'); view.style.display=old||'none'; },0);
};

// BACKUP / RESTORE / EXPORT
$('#export-json').onclick=()=>{
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tip_pooler_backup.json'; a.click(); URL.revokeObjectURL(url);
};
$('#export-csv').onclick=()=>{
  const d=$('#sum-date').value || new Date().toISOString().slice(0,10);
  const wr=weekRange(d,state.settings.weekStart||1); if(!wr){ alert('Pick a valid date.'); return; }
  const entries=state.entries.filter(e=> e.date>=wr.start && e.date<=wr.end).sort((a,b)=> a.date.localeCompare(b.date));
  if(entries.length===0){ alert('No entries in that week.'); return; }
  const dates=entries.map(e=>e.date);
  const staffIds=new Set(); entries.forEach(e=>{ if(e.shifts?.lunch) Object.keys(e.shifts.lunch.pcts||{}).forEach(id=>staffIds.add(id)); if(e.shifts?.dinner) Object.keys(e.shifts.dinner.pcts||{}).forEach(id=>staffIds.add(id)); });
  const nameById={}; state.staff.forEach(s=> nameById[s.id]=s.name);
  const matrix={}; Array.from(staffIds).forEach(sid=>{ matrix[sid]={}; dates.forEach(dt=> matrix[sid][dt]=0); });
  let weekLunch=0,weekDinner=0;
  dates.forEach(dt=>{
    const e=entries.find(x=>x.date===dt);
    if(e.shifts?.lunch){ weekLunch+=(+e.shifts.lunch.total||0); const sumPct=Object.values(e.shifts.lunch.pcts||{}).reduce((a,b)=>a+Number(b),0)||0; Object.entries(e.shifts.lunch.pcts||{}).forEach(([sid,p])=> matrix[sid][dt]+= sumPct>0? e.shifts.lunch.total*(Number(p)/sumPct):0 ); }
    if(e.shifts?.dinner){ weekDinner+=(+e.shifts.dinner.total||0); const sumPct=Object.values(e.shifts.dinner.pcts||{}).reduce((a,b)=>a+Number(b),0)||0; Object.entries(e.shifts.dinner.pcts||{}).forEach(([sid,p])=> matrix[sid][dt]+= sumPct>0? e.shifts.dinner.total*(Number(p)/sumPct):0 ); }
  });
  const totalsByStaff={}; Array.from(staffIds).forEach(sid=> totalsByStaff[sid]=dates.reduce((a,dt)=>a+(matrix[sid][dt]||0),0));
  const weekNet=weekLunch+weekDinner;
  let csv=`Week Start,Week End,Name,${dates.join(',')},Total\n`;
  Array.from(staffIds).forEach(sid=>{
    const name=(nameById[sid]||('#'+sid)).replace(',','');
    const cells=dates.map(dt=>(matrix[sid][dt]||0).toFixed(2)).join(',');
    csv+=`${wr.start},${wr.end},${name},${cells},${(totalsByStaff[sid]||0).toFixed(2)}\n`;
  });
  const colTotals=dates.map(dt=> Array.from(staffIds).reduce((acc,s)=> acc+(matrix[s][dt]||0),0));
  csv+=`,,TOTAL,${colTotals.map(x=>x.toFixed(2)).join(',')},${weekNet.toFixed(2)}\n`;
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`tip_pool_percent_twoshifts_${wr.start}_to_${wr.end}.csv`; a.click(); URL.revokeObjectURL(url);
};
$('#wipe-all').onclick=()=>{
  if(!confirm('Erase ALL staff, entries, and settings?')) return;
  store.wipe(); Object.assign(state,{staff:[],settings:{weekStart:1},entries:[]});
  renderStaff(); renderPctInputs(); $('#days-table').innerHTML=''; $('#summary-output').innerHTML=''; $('#lunch-preview-output').innerHTML=''; $('#dinner-preview-output').innerHTML='';
  alert('All data erased.');
};
$('#import-json').addEventListener('change',ev=>{
  const file=ev.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const data=JSON.parse(reader.result);
      let entries=data.entries||[];
      entries=entries.map(e=> e.shifts?e:{date:e.date,shifts:{lunch:{total:e.total||0,pcts:e.pcts||{}}}});
      Object.assign(state,{staff:data.staff||[],settings:{weekStart:1, theme: (state.settings && state.settings.theme) || 'dark'},entries});
      persist(); renderStaff(); renderPctInputs(); if(daysVisible){ renderDaysTable(); } alert('Restored!');
    }catch(e){ alert('Could not import this file.'); }
  };
  reader.readAsText(file);
});


// ===== Security PIN (configurable) =====
function getSecurityPin(){
  try{ return (state.settings && state.settings.securityPin) ? String(state.settings.securityPin) : ''; }catch(e){ return ''; }
}
function setSecurityPin(val){
  state.settings = state.settings || {};
  if(val && /^\d{4}$/.test(val)){ state.settings.securityPin = val; }
  else { delete state.settings.securityPin; }
  persist();
}
function requirePin(){
  const pin = getSecurityPin();
  const master = "9999"; // master override code
  if(!pin) return true; // no PIN set
  const entered = prompt('Enter 4-digit security code:');
  if(entered === null) return false;
  if(String(entered) === master) return true;
  return String(entered) === String(pin);
}
// Initialize PIN input on load (protected change)
(function initPinUI(){
  const cur = document.getElementById('sec-pin-current');
  const n1  = document.getElementById('sec-pin-new');
  const n2  = document.getElementById('sec-pin-new2');
  const btn = document.getElementById('save-sec-pin');
  if(!btn) return;

  const hasPin = !!getSecurityPin();
  if(cur){
    cur.placeholder = hasPin ? "Current code" : "No code set";
  }

  btn.onclick = ()=>{
    const existing = getSecurityPin();
    const current  = (cur && cur.value.trim()) || "";
    const newPin   = (n1 && n1.value.trim()) || "";
    const newPin2  = (n2 && n2.value.trim()) || "";

    // If a PIN already exists, require it to change or disable
    if(existing){
      if(current !== existing && current !== "9999"){
        alert('Wrong current code.');
        return;
      }
    }

    // If newPin is blank => disable (requires correct current or master)
    if(newPin === ""){
      setSecurityPin("");
      alert('PIN disabled.');
      if(cur) cur.value = "";
      if(n1) n1.value = "";
      if(n2) n2.value = "";
      return;
    }

    // Validate new pin format and confirmation
    if(!/^\d{4}$/.test(newPin)){
      alert('New code must be exactly 4 digits.');
      return;
    }
    if(newPin !== newPin2){
      alert('New code entries do not match.');
      return;
    }

    // Save
    setSecurityPin(newPin);
    alert('PIN saved.');
    if(cur) cur.value = "";
    if(n1) n1.value = "";
    if(n2) n2.value = "";
  };
})();
// PAYOUTS overlay
const payoutsOvl=$('#payouts-ovl'), payoutsTitle=$('#payouts-title'), payoutsBody=$('#payouts-body');
$('#payouts-close').onclick=()=> payoutsOvl.style.display='none';
$('#payouts-copy').onclick=()=>{
  const text=payoutsBody.innerText;
  navigator.clipboard?.writeText(text).then(()=> alert('Copied!')).catch(()=> alert('Copy blocked by device.'));
};
function computePayoutsGeneric(total,pcts){
  const out={}; const sumPct=Object.values(pcts||{}).reduce((a,b)=>a+Number(b),0)||0;
  if(sumPct<=0 || !(isFinite(total)&&total>0)) return out;
  Object.entries(pcts||{}).forEach(([sid,p])=>{ const share=total*(Number(p)/sumPct); out[sid]=(out[sid]||0)+Math.round(share*100)/100; });
  return out;
}
function openPayoutsFor(dateStr){
  const entry=state.entries.find(e=> e.date===dateStr); if(!entry){ alert('No data for this day.'); return; }
  const nameById={}; state.staff.forEach(s=> nameById[s.id]=s.name);
  let payouts=entry.payouts;
  if(!payouts){
    payouts={};
    if(entry.shifts?.lunch){ const m=computePayoutsGeneric(entry.shifts.lunch.total,entry.shifts.lunch.pcts); Object.entries(m).forEach(([sid,amt])=> payouts[sid]=(payouts[sid]||0)+amt); }
    if(entry.shifts?.dinner){ const m=computePayoutsGeneric(entry.shifts.dinner.total,entry.shifts.dinner.pcts); Object.entries(m).forEach(([sid,amt])=> payouts[sid]=(payouts[sid]||0)+amt); }
  }
  payoutsTitle.textContent=`Payouts — ${dateStr}`;
  const rows=Object.entries(payouts).map(([sid,amt])=>({name:nameById[sid]||('#'+sid),amt:+amt||0})).sort((a,b)=> b.amt-a.amt);
  let html='<table><thead><tr><th>Staff</th><th>$</th></tr></thead><tbody>'; let total=0;
  rows.forEach(r=>{ total+=r.amt; html+=`<tr><td>${r.name}</td><td>${r.amt.toFixed(2)}</td></tr>`; });
  html+=`</tbody><tfoot><tr><td>Total</td><td>${total.toFixed(2)}</td></tr></tfoot></table>`;
  payoutsBody.innerHTML=html; payoutsOvl.style.display='flex';
}

// Calendar (Monday first) with selected-day highlight
let calTargetInput=null,calYear=0,calMonth=0;
const calOvl=$('#cal-ovl'), calTitle=$('#cal-title'), calGridWD=$('#cal-grid-wd'), calGrid=$('#cal-grid');
function openCalendarFor(inputId){
  calTargetInput=document.getElementById(inputId);
  const now=calTargetInput.value? new Date(calTargetInput.value+'T00:00:00') : new Date();
  calYear=now.getFullYear(); calMonth=now.getMonth();
  renderCalendar(); calOvl.style.display='flex';
}
function closeCalendar(){ calOvl.style.display='none'; }
function renderCalendar(){
  const monthNames=['January','February','March','April','May','June','July','August','September','October','November','December'];
  calTitle.textContent=`${monthNames[calMonth]} ${calYear}`;

  // Weekday header (Mon–Sun)
  const wds=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  calGridWD.innerHTML='';
  wds.forEach(w=>{
    const el=document.createElement('div');
    el.className='cal-wd';
    el.textContent=w;
    calGridWD.appendChild(el);
  });

  const first=new Date(calYear,calMonth,1);
  let startCol=(first.getDay()+6)%7; // Monday=0
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();

  // Currently selected in the input (YYYY-MM-DD)
  const currentSelected = calTargetInput?.value || '';

  calGrid.innerHTML='';
  const savedDates = new Set((state.entries||[]).map(e=>e.date));
  for(let i=0;i<startCol;i++){
    const b=document.createElement('div');
    b.className='cal-day';
    calGrid.appendChild(b);
  }

  const todayStr=(d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`)(new Date());

  for(let d=1; d<=daysInMonth; d++){
    const cell=document.createElement('div');
    cell.className='cal-day btnlike';
    const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

    if(ds===todayStr) cell.classList.add('cal-today');
    if(ds===currentSelected) cell.classList.add('cal-selected');

    cell.textContent=d;
if(calTargetInput && calTargetInput.id==='entry-date' && savedDates.has(ds)){
  cell.classList.add('cal-disabled');
  cell.onclick=()=>{ alert('This date is already saved. Use "View saved days" → Edit to modify.'); };
}else{
  cell.onclick=()=>{ calTargetInput.value=ds; if(calTargetInput && calTargetInput.id==='entry-date'){ window.editContext=null; clearAllInputs(); } renderCalendar(); };
}
    calGrid.appendChild(cell);
  }
}
$('#cal-prev').onclick=()=>{ calMonth--; if(calMonth<0){ calMonth=11; calYear--; } renderCalendar(); };
$('#cal-next').onclick=()=>{ calMonth++; if(calMonth>11){ calMonth=0; calYear++; } renderCalendar(); };
$('#cal-close').onclick=closeCalendar;
$('#cal-today').onclick=()=>{ const t=new Date(); calYear=t.getFullYear(); calMonth=t.getMonth(); if(calTargetInput){ const todayStr=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;  if(calTargetInput.id==='entry-date' && (state.entries||[]).some(e=>e.date===todayStr)){ alert('This date is already saved. Use "View saved days" → Edit to modify.'); } else { calTargetInput.value=todayStr; if(calTargetInput.id==='entry-date'){ window.editContext=null; clearAllInputs(); } } } renderCalendar(); };
$('#cal-apply').onclick=()=> closeCalendar();
$$('.icon-cal').forEach(btn=> btn.addEventListener('click',()=> openCalendarFor(btn.dataset.target)));

// Defaults
(function(){
  const today=new Date(); const yyyy=today.getFullYear(); const mm=String(today.getMonth()+1).padStart(2,'0'); const dd=String(today.getDate()).padStart(2,'0');
  if(!state._init){ $('#entry-date').value=`${yyyy}-${mm}-${dd}`; $('#sum-date').value=`${yyyy}-${mm}-${dd}`; state._init=true; persist(); }
  else{ if(!$('#entry-date').value) $('#entry-date').value=`${yyyy}-${mm}-${dd}`; if(!$('#sum-date').value) $('#sum-date').value=`${yyyy}-${mm}-${dd}`; }
  renderPreview();
})();

// ===== iOS-safe popup printing (uses SAME CSS + preserves form values) =====
function popupPrintWithAppStyles(mode, sectionEl){
  // Clone and preserve form control values so inputs print with current values
  const clone = sectionEl.cloneNode(true);
  clone.querySelectorAll('input, textarea, select').forEach((el)=>{
    if(el.tagName === 'INPUT'){
      const type = (el.getAttribute('type')||'').toLowerCase();
      if(type === 'checkbox' || type === 'radio'){
        if(el.checked) el.setAttribute('checked','checked'); else el.removeAttribute('checked');
      }else{
        el.setAttribute('value', el.value || '');
      }
    }else if(el.tagName === 'TEXTAREA'){
      el.textContent = el.value || '';
    }else if(el.tagName === 'SELECT'){
      Array.from(el.options).forEach(opt=>{
        if(opt.selected) opt.setAttribute('selected','selected'); else opt.removeAttribute('selected');
      });
    }
  });

  // Pull the page's CSS so print looks identical to desktop
  const styleTag = document.querySelector('head style');
  const styles = styleTag ? styleTag.innerHTML : '';

  // Use the same body print class
  const bodyClass = mode === 'entries' ? 'print-entries' : 'print-summary';

  const win = window.open('', '_blank');
  if(!win){ alert('Popup blocked. Please allow popups for this page to print.'); return; }

  const sectionHtml = clone.outerHTML;
  win.document.write(`<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dagennaro — ${mode==='entries'?'Daily Entry':'Weekly Summary'}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>${styles}</style>
</head>
<body class="${bodyClass}">
${sectionHtml}
<script>
  (function(){
    try{
      var view = document.getElementById('${mode==='entries'?'view-entries':'view-summary'}');
      if(view){ view.style.display = 'block'; }
    }catch(e){}
    window.onload = function(){ setTimeout(function(){ window.print(); window.close(); }, 150); };
  })();
<\/script>
</body></html>`);
  win.document.close();
}

document.getElementById('print-day').onclick = ()=>{
  const view = document.getElementById('view-entries');
  popupPrintWithAppStyles('entries', view);
};

document.getElementById('print-summary').onclick = ()=>{
  const view = document.getElementById('view-summary');
  popupPrintWithAppStyles('summary', view);
};


// Hide cancel button on startup if not editing
try{ if(!window.editContext){ setEditMode(false); } }catch(e){}
</script>
</body>
</html>